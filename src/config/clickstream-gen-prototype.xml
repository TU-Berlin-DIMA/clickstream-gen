<?xml version='1.0' encoding='UTF-8'?>
<generator_prototype xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' xmlns='http://www.dima.tu-berlin.de/myriad/prototype'>

  <!-- configurable parameters -->
  <parameters>
    <parameter key='user.sequence.cardinality'>20000000</parameter>
    <parameter key='product.sequence.cardinality'>5000</parameter>
    <parameter key='session.timespan.min-date'>2012-01-01 00:00:00</parameter>
    <parameter key='session.timespan.max-date'>2012-04-10 00:00:00</parameter>
    <parameter key='session.timespan.pattern.probability'>Pr[session.density]</parameter>
    <parameter key='session.timespan.pattern.period'>86400</parameter>
  </parameters>

  <!-- function configuration -->
  <functions>
    <!-- user -->
    <function key='Pr[user.ip_address]' type='uniform_probability[I32u]'>
      <argument key='x_min' type='Enum' value='3221225473' />
      <argument key='x_max' type='Enum' value='3758096383' />
    </function>
    
    <!-- product -->
    <function key='Pr[product.category]' type='combined_probability[Enum]'>
      <argument key='path' type='String' value='${%ENV.config-dir% + "/distributions/product/category.distribution"}' />
    </function>

    <!-- session -->
    <function key='Pr[session.primary_category]' type='combined_probability[Enum]'>
      <argument key='path' type='String' value='${%ENV.config-dir% + "/distributions/session/primary_category.distribution"}' />
    </function>
    <function key='Pr[session.type]' type='combined_probability[Enum]'>
      <argument key='path' type='String' value='${%ENV.config-dir% + "/distributions/session/type.distribution"}' />
    </function>
    <function key='Pr[session.density]' type='normal_probability[I32u]'>
      <argument key='mean' type='I32u' value='0' />
      <argument key='stddev' type='I32u' value='5' />
    </function>
    <function key='Pr[session.number_of_requests]' type='normal_probability[I32u]'>
      <argument key='mean' type='I32u' value='8' />
      <argument key='stddev' type='I32u' value='2' />
    </function>

    <!-- request -->
    <function key='Pr[request.product_category]' type='combined_probability[Enum]'>
      <argument key='path' type='String' value='${%ENV.config-dir% + "/distributions/request/product_category.distribution"}' />
    </function>
    <function key='Pr[request.product]' type='normal_probability[I32u]'>
      <argument key='mean' type='I32u' value='0' />
      <argument key='stddev' type='I32u' value='5' />
    </function>
    <function key='Pr[request.server]' type='uniform_probability[Enum]'>
      <argument key='x_min' type='Enum' value='0' />
      <argument key='x_max' type='Enum' value='11' />
    </function>
  </functions>

  <!-- enumeration types -->
  <enum_sets>
    <!-- product -->
    <enum_set key='product.category'>
      <argument key='path' type='String' value='${%ENV.config-dir% + "/domains/product_category.domain"}' />
    </enum_set>

    <!-- request -->
    <enum_set key='request.type'>
      <argument key='path' type='String' value='${%ENV.config-dir% + "/domains/request_type.domain"}' />
    </enum_set>
    <enum_set key='request.method'>
      <argument key='path' type='String' value='${%ENV.config-dir% + "/domains/request_method.domain"}' />
    </enum_set>
  </enum_sets>

  <record_sequences>
    <!-- user -->
    <random_sequence key='user'>
      <record_type>
        <field name='pk' type='I64u' />
        <field name='ip_address' type='I32u' />
      </record_type>
      <output_format type='csv'>
        <argument key='delimiter' type='Char' value='|' />
        <argument key='field' type='field_ref' ref='user:pk' />
        <argument key='field' type='field_ref' ref='user:ip_address' />
      </output_format>
      <setter_chain>
        <setter key='set_pk' type='field_setter'>
          <argument key='field' type='field_ref' ref='user:pk' />
          <argument key='value' type='clustered_value_provider[I64u]'>
            <argument key='probability' type='function_ref' ref='Pr[request.pk]' />
            <argument key='cardinality' type='const_range_provider[I64u]'>
              <argument key='min' type='I64u' value='1' />
              <argument key='max' type='I64u' value='${%user.sequence.cardinality% + 1}' />
            </argument>
          </argument>
        </setter>
        <setter key='set_ip_address' type='field_setter'>
          <argument key='field' type='field_ref' ref='user:ip_address' />
          <argument key='value' type='random_value_provider[I32u]'>
            <argument key='probability' type='function_ref' ref='Pr[user.ip_address]' />
          </argument>
        </setter>
      </setter_chain>
      <cardinality_estimator type='const_estimator'>
        <argument key='cardinality' type='I64u' value='%user.sequence.cardinality%' />
      </cardinality_estimator>
      <sequence_iterator type='partitioned_iterator' />
    </random_sequence>

    <!-- session -->
    <random_sequence key='session'>
      <record_type>
        <field name='pk' type='I64u' />
        <field name='type' type='I32u' />
        <field name='number_of_requests' type='I32u' />
        <field name='session_start' type='I32u' />
        <field name='primary_product_category' type='Enum' enumref='product.category' />
        <reference name='user' type='user' />
      </record_type>
      <output_format type='csv'>
        <argument key='delimiter' type='Char' value='|' />
        <argument key='field' type='field_ref' ref='session:pk' />
      </output_format>
      <cardinality_estimator type='const_estimator'>
        <argument key='cardinality' type='I64u' value='%user.sequence.cardinality%' />
      </cardinality_estimator>
      <sequence_iterator type='partitioned_iterator' />
    </random_sequence>

    <!-- request -->
    <random_sequence key='request'>
      <record_type>
        <field name='position' type='I32u' />
        <field name='server' type='String' />
        <field name='type'  type='Enum' enumref='request.type' />
        <field name='method' type='Enum' enumref='request.method' />
        <field name='timestamp' type='Date' />
        <field name='browseCount' type='I16u' />
        <field name='product_category' type='Enum' enumref='product.category' />
        <field name='product_interval' type='Enum' enumref='product.category' />
        <reference name='product' type='product' />
        <reference name='session' type='session' />
      </record_type>
      <output_format type='csv'>
        <argument key='delimiter' type='Char' value='|' />
        <argument key='field' type='field_ref' ref='request:server' />
        <argument key='field' type='field_ref' ref='request:type' />
        <argument key='field' type='field_ref' ref='request:method' />
      </output_format>
      <!-- 
      <setter_chain>
        <setter key='set_pk' type='field_setter'>
          <argument key='field' type='field_ref' ref='customer:pk' />
          <argument key='value' type='clustered_value_provider[I64u]'>
            <argument key='probability' type='function_ref' ref='Pr[request.pk]' />
            <argument key='cardinality' type='const_range_provider[I64u]'>
              <argument key='min' type='I64u' value='0' />
              <argument key='max' type='I64u' value='%request.sequence.cardinality%' />
            </argument>
          </argument>
        </setter>
        <setter key='set_gender' type='field_setter'>
          <argument key='field' type='field_ref' ref='customer:gender' />
          <argument key='value' type='random_value_provider[Enum]'>
            <argument key='probability' type='function_ref' ref='Pr[request.gender]' />
          </argument>
        </setter>
        <setter key='set_first_name' type='field_setter'>
          <argument key='field' type='field_ref' ref='customer:first_name' />
          <argument key='value' type='random_value_provider[Enum]'>
            <argument key='probability' type='function_ref' ref='Pr[request.first_name]' />
            <argument key='condition_field' type='field_ref' ref='customer:gender' />
          </argument>
        </setter>
        <setter key='set_last_name' type='field_setter'>
          <argument key='field' type='field_ref' ref='customer:last_name' />
          <argument key='value' type='random_value_provider[Enum]'>
            <argument key='probability' type='function_ref' ref='Pr[request.last_name]' />
          </argument>
        </setter>
        <setter key='set_age' type='field_setter'>
          <argument key='field' type='field_ref' ref='customer:age' />
          <argument key='value' type='random_value_provider[I16u]'>
            <argument key='probability' type='function_ref' ref='Pr[request.age]' />
          </argument>
        </setter>
      </setter_chain>
      -->
      <cardinality_estimator type='linear_scale_estimator'>
        <argument key='base_cardinality' type='I64u' value='%request.sequence.base_cardinality%' />
      </cardinality_estimator>
      <sequence_iterator type='partitioned_iterator' />
    </random_sequence>
  </record_sequences>
</generator_prototype>

